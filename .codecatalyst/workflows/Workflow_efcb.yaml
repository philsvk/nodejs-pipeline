Name: pull-request
SchemaVersion: "1.0"
Triggers:
  - Type: PULLREQUEST
    Events:
      - OPEN
      - REVISION
    Branches:
      - dev
Actions:
  Build:
    Actions:
      SCA:
        Identifier: aws/github-actions-runner@v1
        Inputs:
          Sources:
            - WorkflowSource
        Configuration:
          Steps:
            - name: Trivy Vulnerability Scanner
              uses: aquasecurity/trivy-action@master
              with:
                scan-type: fs
                ignore-unfixed: true
                format: sarif
                output: report.sarif
                security-checks: vuln,config,secret
        Outputs:
          Reports:
            SCA:
              Format: SARIFSCA
              IncludePaths:
                - report.sarif
              SuccessCriteria:
                Vulnerabilities:
                  Severity: HIGH
                  Number: 0
      DockerBuild:
        Identifier: aws/build@v1
        Inputs:
          Sources:
            - WorkflowSource
        Configuration:
          Steps:
            - Run: echo "Building Docker Image"
            - Run: docker build -t node-app .
            - Run: echo "Running Unit Test"
            - Run: docker run --rm node-app:latest npm test
            - Run: echo "Run linting"
            - Run: docker run --rm node-app:latest npm run lint
        Compute:
          Type: EC2
        Outputs:
          AutoDiscoverReports:
            Enabled: true
            ReportNamePrefix: build
            SuccessCriteria:
              PassRate: 100
RunMode: SUPERSEDED
